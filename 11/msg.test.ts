import { expect, test, describe } from "bun:test"
import {
  MessageEncoder,
  MessageType,
  parseMessageHello,
  parseMessagePolicyResult,
  parseMessageSiteVisit,
  parseMessageTargetPopulations,
  PolicyAction,
} from "./msg"

describe("parse msg Hello", () => {
  test("ok", () => {
    expect(
      parseMessageHello(
        Buffer.from([
          0x50, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0x0b, 0x70, 0x65,
          0x73, 0x74, 0x63, 0x6f, 0x6e, 0x74, 0x72, 0x6f, 0x6c, 0x00, 0x00,
          0x00, 0x01, 0xce,
        ])
      )
    ).toEqual({
      type: MessageType.hello,
      protocol: "pestcontrol",
      version: 1,
    })
  })

  test("invalid total length", () => {
    expect(() =>
      parseMessageHello(Buffer.from([0x50, 0x00, 0x00, 0x00, 0x00]))
    ).toThrow()
  })

  test("str length too big", () => {
    expect(() =>
      parseMessageHello(
        Buffer.from([
          0x50, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0xab, 0x70, 0x65,
          0x73, 0x74, 0x63, 0x6f, 0x6e, 0x74, 0x72, 0x6f, 0x6c, 0x00, 0x00,
          0x00, 0x01, 0xce,
        ])
      )
    ).toThrow()
  })

  test("str length too small", () => {
    expect(() =>
      parseMessageHello(
        Buffer.from([
          0x50, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0x0a, 0x70, 0x65,
          0x73, 0x74, 0x63, 0x6f, 0x6e, 0x74, 0x72, 0x6f, 0x6c, 0x00, 0x00,
          0x00, 0x01, 0xce,
        ])
      )
    ).toThrow()
  })
})

describe("parse msg TargetPopulatons", () => {
  test("ok", () => {
    expect(
      parseMessageTargetPopulations(
        Buffer.from([
          0x54, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x30, 0x39, 0x00, 0x00,
          0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x64, 0x6f, 0x67, 0x00, 0x00,
          0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x72,
          0x61, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x80,
        ])
      )
    ).toEqual({
      type: MessageType.targetPopulations,
      site: 12345,
      populations: [
        { species: "dog", min: 1, max: 3 },
        { species: "rat", min: 0, max: 10 },
      ],
    })
  })
})

describe("parse msg PolicyResult", () => {
  test("ok", () => {
    expect(
      parseMessagePolicyResult(
        Buffer.from([
          0x57, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x7b, 0x24,
        ])
      )
    ).toEqual({
      type: MessageType.policyResult,
      policy: 123,
    })
  })
})

describe("parse msg SiteVisit", () => {
  test("ok", () => {
    expect(
      parseMessageSiteVisit(
        Buffer.from([
          0x58, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x30, 0x39, 0x00, 0x00,
          0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x64, 0x6f, 0x67, 0x00, 0x00,
          0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x72, 0x61, 0x74, 0x00, 0x00,
          0x00, 0x05, 0x8c,
        ])
      )
    ).toEqual({
      type: MessageType.siteVisit,
      site: 12345,
      populations: [
        { species: "dog", count: 1 },
        { species: "rat", count: 5 },
      ],
    })
  })
})

describe("Encoder", () => {
  test("siteVisit", () => {
    expect(
      MessageEncoder.siteVisit(12345, [
        { species: "dog", count: 1 },
        { species: "rat", count: 5 },
      ])
    ).toEqual(
      Buffer.from([
        0x58, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x30, 0x39, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x00, 0x00, 0x03, 0x64, 0x6f, 0x67, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x03, 0x72, 0x61, 0x74, 0x00, 0x00, 0x00, 0x05, 0x8c,
      ])
    )
  })

  test("hello", () => {
    expect(MessageEncoder.hello()).toEqual(
      Buffer.from([
        0x50, 0x00, 0x00, 0x00, 0x19, 0x00, 0x00, 0x00, 0x0b, 0x70, 0x65, 0x73,
        0x74, 0x63, 0x6f, 0x6e, 0x74, 0x72, 0x6f, 0x6c, 0x00, 0x00, 0x00, 0x01,
        0xce,
      ])
    )
  })

  test("deletePolicy", () => {
    expect(MessageEncoder.deletePolicy(123)).toEqual(
      Buffer.from([0x56, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x7b, 0x25])
    )
  })

  test("createPolicy", () => {
    expect(MessageEncoder.createPolicy("dog", PolicyAction.conserve)).toEqual(
      Buffer.from([
        0x55, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x03, 0x64, 0x6f, 0x67,
        0xa0, 0xc0,
      ])
    )
  })

  test("error", () => {
    expect(MessageEncoder.error("bad")).toEqual(
      Buffer.from([
        0x51, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x03, 0x62, 0x61, 0x64,
        0x78,
      ])
    )
  })

  test("dialAuthority", () => {
    expect(MessageEncoder.dialAuthority(12345)).toEqual(
      Buffer.from([0x53, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x30, 0x39, 0x3a])
    )
  })
})
